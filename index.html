<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link type="text/css" rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-table@1.18.3/dist/bootstrap-table.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-table@1.18.3/dist/bootstrap-table.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.all.min.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/bootstrap-table@1.18.3/dist/extensions/filter-control/bootstrap-table-filter-control.min.js"></script>
</head>

<body>
    <div id="loadingOverlay" class="overlay">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
    <h2>MRU Data</h2>
    <div id="toolbar">
        <button id="exportButton" class="btn btn-success"><i class="fas fa-file-excel"></i>  Export to Excel</button>
        <button id="applyFilterButton" class="btn btn-primary">Filter MRU NOT 98</button>
        <button id="refreshButton" class="btn btn-warning">Refresh</button>
    </div>

    <table data-url="data.json" id="resultTable" data-toggle="table" data-sortable="true" data-page-size="40"
        data-pagination="true" data-search="true" data-show-columns="true" data-show-multi-sort="true"
        data-show-export="true" data-click-to-select="true" data-toolbar="#toolbar" data-export-types="['excel']"
        data-filter-control="true" data-export-options='{"fileName": "selectedRows"}'>
        <thead>
            <tr>
                <th data-checkbox="true"></th>
                <th data-field="MRU" data-filter-control="input" data-sortable="true">MRU</th>
                <th data-field="TERMTEXT" data-filter-control="input" data-sortable="true" data-width="500"
                    style="white-space: nowrap;">TERMTEXT</th>
                <th data-field="PORTION" data-filter-control="input" data-sortable="true">PORTION</th>
                <th data-field="MDENR" data-filter-control="input" data-sortable="true">MDENR</th>
                <th data-field="ORD_CRT_TO_MR" data-filter-control="input" data-sortable="true">ORD_CRT_TO_MR</th>
                <th data-field="DOWNLOAD_BY_MR" data-filter-control="input" data-sortable="true">DOWNLOAD_BY_MR</th>
                <th data-field="ABL_Z" data-filter-control="input" data-sortable="true">ABL_Z</th>
            </tr>
        </thead>
        <tbody id="resultTableBody">
            <!-- Data will be dynamically populated here -->
        </tbody>
    </table>

    <script>
        $(document).ready(function () {
            const table = $('#resultTable');
            const exportButton = $('#exportButton');
            const applyFilterButton = $('#applyFilterButton');
            const refreshButton = $('#refreshButton');

            let originalData = [];

            function showLoadingSpinner() {
                $('#loadingOverlay').show();
            }

            function hideLoadingSpinner() {
                $('#loadingOverlay').hide();
            }

            table.bootstrapTable({
                sortName: 'MRU',
                sortOrder: 'asc',
                sidePagination: 'server',
                pagination: true,
                showColumns: true,
                showRefresh: true,
                showToggle: true,
                showPaginationSwitch: true,
                showMultiSort: true,
                showExport: true,
                clickToSelect: true,
                toolbar: '#toolbar',
                clickToSelect: true,
                clickToSelectMultiple: true,
            });

            // Load the original data when the table is loaded
            table.on('load-success.bs.table', function (e, data) {
                originalData = [...data];
                hideLoadingSpinner();
            });

            table.on('check.bs.table uncheck.bs.table check-all.bs.table uncheck-all.bs.table', function () {
                const selectedRows = table.bootstrapTable('getSelections');
                exportButton.prop('disabled', selectedRows.length === 0);
            });

            applyFilterButton.click(() => {
                // Filter the originalData based on the condition
                const filteredRows = originalData.filter(row => {
                    const lastFourCharacters = row.MRU.slice(-4);
                    return !lastFourCharacters.startsWith("98");
                });

                Swal.fire({
                    title: 'Filtered Results',
                    text: `Number of results: ${filteredRows.length}`,
                    icon: 'info',
                    confirmButtonText: 'OK'
                });

                // Load the filtered data into the table using Bootstrap Table's load method
                // Assuming `table` is your Bootstrap Table instance
                table.bootstrapTable('load', filteredRows);
            });


            refreshButton.click(() => {
                // Reset the table to the original data
                table.bootstrapTable('load', originalData);
            });

            exportButton.click(() => {
                const selectedRows = table.bootstrapTable('getSelections');

                if (selectedRows.length === 0) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'No Rows Selected',
                        text: 'Please select at least one row for export.',
                    });
                    return;
                }

                // Continue with the export logic for selected rows
                const headers = table.bootstrapTable('getVisibleColumns').map(column => column.field);
                const data = selectedRows.map(row => headers.map(header => row[header]));

                const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Sheet 1');
                XLSX.writeFile(wb, 'selectedRows.xlsx');

                // Display SweetAlert with total selected rows count
                Swal.fire({
                    icon: 'success',
                    title: 'Export Successful',
                    html: `Total selected rows: ${selectedRows.length}`,
                });

                table.bootstrapTable('uncheckAll');
            });
        });
    </script>

</body>

</html>